
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mottu Gestor Dashboard (IoT + VisÃ£o)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui, Arial; margin:20px; background:#0b0f14; color:#e6edf3}
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px}
    .card{background:#111827; padding:16px; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.2)}
    h1{margin:0 0 8px}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px; border-bottom:1px solid #1f2937}
    .pill{padding:2px 8px; border-radius:999px; background:#1f2937}
    .topic{font-size:12px; opacity:.8}
  </style>
</head>
<body>
  <h1>ðŸš¦ Mottu Gestor â€” Telemetria & VisÃ£o em Tempo Real</h1>
  <p class="topic">Pipeline: CÃ¢meras/Simuladores â†’ MQTT/YOLO Inference â†’ FastAPI â†’ SSE</p>
  <div class="cards">
    <div class="card">
      <h3>MÃ©tricas</h3>
      <div id="metrics">carregando...</div>
    </div>
    <div class="card">
      <h3>Ãšltimas leituras RFID</h3>
      <table id="rfid"><thead><tr><th>Tag</th><th>Gate</th><th>ts</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Status de Zonas</h3>
      <table id="zones"><thead><tr><th>Zona</th><th>Qtde</th><th>ts</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Eventos de ViolaÃ§Ã£o</h3>
      <table id="tamper"><thead><tr><th>Device</th><th>Estado</th><th>ts</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>DetecÃ§Ãµes de VisÃ£o</h3>
      <table id="vision"><thead><tr><th>Classe</th><th>ConfianÃ§a</th><th>ts</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
<script>
const rfidT = document.querySelector("#rfid tbody");
const zoneT = document.querySelector("#zones tbody");
const tampT = document.querySelector("#tamper tbody");
const visT  = document.querySelector("#vision tbody");
const metricsDiv = document.querySelector("#metrics");

async function refreshMetrics(){
  try{
    const r = await fetch("/metrics");
    const j = await r.json();
    metricsDiv.innerHTML = `<div>RFID: <span class="pill">${j.rfid_reads}</span></div>
    <div>Zonas: <span class="pill">${j.zone_updates}</span></div>
    <div>Tamper: <span class="pill">${j.tampers}</span></div>
    <div>VisÃ£o: <span class="pill">${j.vision}</span></div>
    <div>MÃ©dia LatÃªncia: <span class="pill">${Math.round(j.avg_latency_ms||0)} ms</span></div>`;
  }catch(e){ metricsDiv.textContent = "erro ao carregar mÃ©tricas"; }
}
setInterval(refreshMetrics, 2000); refreshMetrics();

const es = new EventSource("/events");
es.addEventListener("update", (evt) => {
  const obj = JSON.parse(evt.data);
  const t = new Date().toLocaleTimeString();
  if(obj.topic==="mottu/rfid/read"){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${obj.payload.tag}</td><td>${obj.payload.gate}</td><td>${t}</td>`;
    rfidT.prepend(tr); if(rfidT.rows.length>10) rfidT.deleteRow(10);
  } else if(obj.topic==="mottu/zone/heartbeat"){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${obj.payload.zone}</td><td>${obj.payload.count}</td><td>${t}</td>`;
    zoneT.prepend(tr); if(zoneT.rows.length>10) zoneT.deleteRow(10);
  } else if(obj.topic==="mottu/tamper"){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${obj.payload.device}</td><td>${obj.payload.state}</td><td>${t}</td>`;
    tampT.prepend(tr); if(tampT.rows.length>10) tampT.deleteRow(10);
  } else if(obj.topic==="mottu/vision/detections"){
    const preds = obj.payload.predictions || [];
    for (const p of preds){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${p.class}</td><td>${(p.confidence*100).toFixed(1)}%</td><td>${t}</td>`;
      visT.prepend(tr); if(visT.rows.length>10) visT.deleteRow(10);
    }
  }
});
</script>
</body>
</html>
